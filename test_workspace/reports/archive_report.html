
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webnovel Archive Report</title>
    <style>

    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; background-color: #f8f9fa; color: #212529; font-size: 16px; line-height: 1.6; }
    .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    .report-title { text-align: center; color: #343a40; margin-bottom: 30px; font-size: 2.5em; font-weight: 300; }
    .story-card { border: 1px solid #dee2e6; margin-bottom: 25px; padding: 20px; background-color: #fff; border-radius: 8px; display: flex; flex-wrap: nowrap; gap: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .story-cover { flex-basis: 150px; flex-grow: 0; flex-shrink: 0; }
    .story-cover img { max-width: 100%; height: auto; border-radius: 4px; border: 1px solid #ced4da; }
    .story-details { flex-grow: 1; min-width: 0; } /* Prevents flex item from overflowing */
    .story-card h2 { margin-top: 0; font-size: 1.75em; font-weight: 500; color: #007bff; }
    .story-card h2 a { text-decoration: none; color: inherit; }
    .story-card h2 a:hover { text-decoration: underline; }
    .story-card p { margin-top: 0; margin-bottom: 0.75em; color: #495057; }
    .synopsis { max-height: 6em; /* Approx 3-4 lines based on line-height */ overflow: hidden; transition: max-height 0.3s ease-out; margin-bottom: 0px; position: relative; cursor: pointer;}
    .synopsis.expanded { max-height: 500px; /* Sufficiently large */ }
    .synopsis-toggle { color: #007bff; cursor: pointer; display: block; margin-top: 0px; font-size: 0.9em; text-align: right; }
    .progress-bar-container { background-color: #e9ecef; border-radius: .25rem; height: 22px; overflow: hidden; margin-bottom: 8px; }
    .progress-bar { background-color: #28a745; height: 100%; line-height: 22px; color: white; text-align: center; font-weight: bold; transition: width 0.4s ease; font-size: 0.85em; }
    .badge { display: inline-block; padding: .35em .65em; font-size: .75em; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; }
    .status-complete { background-color: #28a745; color: white; }
    .status-ongoing { background-color: #ffc107; color: #212529; }
    .status-possibly-complete-total-unknown { background-color: #17a2b8; color: white; }
    .status-unknown-no-chapters-downloaded-total-unknown { background-color: #6c757d; color: white; }
    .backup-ok { background-color: #28a745; color: white; }
    .backup-failed { background-color: #dc3545; color: white; }
    .backup-never-backed-up { background-color: #6c757d; color: white; } /* Adjusted class name */
    .backup-partial-unknown { background-color: #ffc107; color: #212529; }
    .backup-ok-timestamp-missing { background-color: #17a2b8; color: white; }
    .section-title { font-weight: bold; margin-top: 12px; margin-bottom: 6px; font-size: 0.95em; color: #343a40; border-bottom: 1px solid #eee; padding-bottom: 3px;}
    .file-list { list-style: none; padding-left: 0; margin-bottom: 10px; }
    .file-list li { font-size: 0.9em; margin-bottom: 4px; color: #495057; word-break: break-all; }
    .file-list li a { text-decoration: none; color: #007bff; }
    .file-list li a:hover { text-decoration: underline; }
    .no-items { color: #6c757d; font-style: italic; font-size: 0.9em; }
    .search-sort-filter { margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
    .search-sort-filter input, .search-sort-filter select { padding: 10px; border-radius: 4px; border: 1px solid #ced4da; font-size: 0.95em; }
    .search-sort-filter input[type="text"] { flex-grow: 1; min-width: 200px; }

    /* Pagination Styles */
    .pagination-controls { text-align: center; margin-top: 20px; padding: 10px 0; }
    .pagination-controls .page-button, .pagination-controls .page-link {
        display: inline-block; padding: 8px 12px; margin: 0 4px;
        border: 1px solid #ddd; background-color: #f9f9f9;
        color: #007bff; text-decoration: none; border-radius: 4px; cursor: pointer;
        transition: background-color 0.2s, color 0.2s;
    }
    .pagination-controls .page-link.active { background-color: #007bff; color: white; border-color: #007bff; }
    .pagination-controls .page-button:hover, .pagination-controls .page-link:hover:not(.active) { background-color: #e9e9e9; }
    .pagination-controls .page-button.disabled, .pagination-controls .page-link.disabled {
        color: #aaa; cursor: not-allowed; background-color: #f0f0f0; border-color: #eee;
    }
    .pagination-controls .page-ellipsis { display: inline-block; padding: 8px 0; margin: 0 4px; border: none; background: none; color: #555; }

    /* Toggle Epubs Button Style */
    .toggle-epubs-btn {
        background: none;
        border: none;
        color: #007bff;
        text-decoration: underline;
        cursor: pointer;
        padding: 5px 0;
        font-size: 0.85em;
        display: block; /* Or inline-block as needed */
        margin-top: 5px;
    }
    .toggle-epubs-btn:hover {
        color: #0056b3;
    }

    /* EPUB Grid Styles */
    .epub-grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 15px;
        padding: 10px 0; /* Add some padding above/below the grid */
        margin-bottom: 10px; /* Space before the 'Show all' button if it's outside */
    }
    .epub-grid-item {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        background-color: #f9f9f9;
        border-radius: 4px;
        transition: box-shadow 0.2s ease-in-out;
    }
    .epub-grid-item:hover {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .epub-cover-placeholder { /* Shared with modal */
        font-size: 3em; /* Larger book icon */
        margin-bottom: 8px;
        color: #888;
    }
    .epub-name {
        font-size: 0.85em;
        color: #333;
        word-break: break-word; /* Ensure long names wrap */
        line-height: 1.2;
    }

    /* Modal Styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
    }
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto; /* 10% from the top and centered */
        padding: 25px;
        border: 1px solid #bbb;
        width: 80%; /* Could be more or less, depending on screen size */
        max-width: 500px; /* Maximum width */
        border-radius: 8px;
        position: relative;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        text-align: center; /* Center content like title and placeholder */
    }
    .modal-close-btn {
        color: #aaa;
        position: absolute; /* Position relative to modal-content */
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
    }
    .modal-close-btn:hover,
    .modal-close-btn:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }
    #modalEpubName {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.5em;
        color: #333;
    }
    /* #modalEpubCoverPlaceholder is styled by .epub-cover-placeholder */
    #modalEpubPath {
        font-family: monospace;
        font-size: 0.9em;
        color: #555;
        word-break: break-all;
        display: inline-block; /* Allow centering if text-align center on parent */
        margin-bottom: 10px;
    }
    #modalEpubPathLink {
        display: inline-block;
        margin-top: 15px;
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 4px;
        transition: background-color 0.2s;
    }
    #modalEpubPathLink:hover {
        background-color: #0056b3;
    }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="report-title">Webnovel Archive Report</h1>

    <div class="search-sort-filter">
        <input type="text" id="searchInput" onkeyup="filterStories()" placeholder="Search by title or author..." aria-label="Search stories">
        <select id="sortSelect" onchange="sortStories()" aria-label="Sort stories by">
            <option value="title">Sort by Title (A-Z)</option>
            <option value="last_updated_desc">Sort by Last Updated (Newest First)</option>
            <option value="last_updated_asc">Sort by Last Updated (Oldest First)</option>
            <option value="progress_desc">Sort by Progress (Highest First)</option>
        </select>
        <select id="filterStatusSelect" onchange="filterStories()" aria-label="Filter stories by status">
            <option value="">Filter by Status (All)</option>
            <option value="Complete">Complete</option>
            <option value="Ongoing">Ongoing</option>
            <option value="Possibly Complete (Total Unknown)">Possibly Complete</option>
            <option value="Unknown (No chapters downloaded, total unknown)">Unknown</option>
            <option value="Complete">Complete</option><option value="Ongoing">Ongoing</option><option value="Possibly Complete (Total Unknown)">Possibly Complete (Total Unknown)</option><option value="Unknown (No chapters downloaded, total unknown)">Unknown (No chapters downloaded, total unknown)</option>
        </select>
    </div>

        <div id="storyListContainer">
    <div class="story-card" data-title="Story 456 Title" data-author="Author FourFiveSix" data-status="Ongoing" data-last-updated="" data-progress="0">
        <div class="story-cover">
            <img src="https://via.placeholder.com/150x220.png?text=No+Cover" alt="Cover for Story 456 Title">
        </div>
        <div class="story-details">
            <h2><a href="http://example.com/story456" target="_blank">Story 456 Title</a></h2>
            <p><strong>Author:</strong> Author FourFiveSix</p>

            <p class="section-title">Synopsis:</p>
            <div class="synopsis" onclick="toggleSynopsis(this)">A tale of 456 challenges.</div>
            <span class="synopsis-toggle" onclick="toggleSynopsis(this.previousElementSibling)">(Read more)</span>

            <p class="section-title">Download Progress:</p>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width:0%;">0%</div>
            </div>
            <p>0 / 50 chapters</p>
            <p><strong>Story Status:</strong> <span class="badge status-ongoing">Ongoing</span></p>

            <p class="section-title">Local EPUBs (Generated: 2024-06-06 11:00:00 UTC):</p>
            <div class="epub-grid-container">
        <div class="epub-grid-item" data-epub-name="story456_complete.epub" data-epub-path="/app/test_workspace/ebooks/story456/story456_complete.epub" onclick="openEpubModal(this)">
            <div class="epub-cover-placeholder">ðŸ“–</div>
            <div class="epub-name" title="story456_complete.epub">story456_complete.epub</div>
        </div></div>

            <p class="section-title">Cloud Backup:</p>
            <p><strong>Status:</strong> <span class="badge backup-never-backed-up">Never Backed Up</span>
               (Service: N/A)
            </p>
            <p>Last Successful Backup: N/A</p>
            <p class="no-items">No backup file details.</p>

            <p class="section-title">Last Local Update:</p>
            <p>2024-06-06 11:00:00 UTC</p>
        </div>
    </div>

    <div class="story-card" data-title="Story 123 Title" data-author="Author Three" data-status="Ongoing" data-last-updated="" data-progress="0">
        <div class="story-cover">
            <img src="https://via.placeholder.com/150x220.png?text=No+Cover" alt="Cover for Story 123 Title">
        </div>
        <div class="story-details">
            <h2><a href="http://example.com/story123" target="_blank">Story 123 Title</a></h2>
            <p><strong>Author:</strong> Author Three</p>

            <p class="section-title">Synopsis:</p>
            <div class="synopsis" onclick="toggleSynopsis(this)">A tale of 123 adventures.</div>
            <span class="synopsis-toggle" onclick="toggleSynopsis(this.previousElementSibling)">(Read more)</span>

            <p class="section-title">Download Progress:</p>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width:0%;">0%</div>
            </div>
            <p>0 / 100 chapters</p>
            <p><strong>Story Status:</strong> <span class="badge status-ongoing">Ongoing</span></p>

            <p class="section-title">Local EPUBs (Generated: 2024-06-06 10:00:00 UTC):</p>
            <div class="epub-grid-container">
        <div class="epub-grid-item" data-epub-name="story123_vol1.epub" data-epub-path="/app/test_workspace/ebooks/story123/story123_vol1.epub" onclick="openEpubModal(this)">
            <div class="epub-cover-placeholder">ðŸ“–</div>
            <div class="epub-name" title="story123_vol1.epub">story123_vol1.epub</div>
        </div>
        <div class="epub-grid-item" data-epub-name="story123_vol2.epub" data-epub-path="/app/test_workspace/ebooks/story123/story123_vol2.epub" onclick="openEpubModal(this)">
            <div class="epub-cover-placeholder">ðŸ“–</div>
            <div class="epub-name" title="story123_vol2.epub">story123_vol2.epub</div>
        </div>
        <div class="epub-grid-item" data-epub-name="story123_vol3.epub" data-epub-path="/app/test_workspace/ebooks/story123/story123_vol3.epub" onclick="openEpubModal(this)">
            <div class="epub-cover-placeholder">ðŸ“–</div>
            <div class="epub-name" title="story123_vol3.epub">story123_vol3.epub</div>
        </div></div><div id="more-epubs-story123" style="display:none;" class="epub-grid-container">
        <div class="epub-grid-item" data-epub-name="story123_vol4.epub" data-epub-path="/app/test_workspace/ebooks/story123/story123_vol4.epub" onclick="openEpubModal(this)">
            <div class="epub-cover-placeholder">ðŸ“–</div>
            <div class="epub-name" title="story123_vol4.epub">story123_vol4.epub</div>
        </div></div><button type="button" class="toggle-epubs-btn" onclick="toggleExtraEpubs('story123', this, 4, 3)">Show all 4 EPUBs</button>

            <p class="section-title">Cloud Backup:</p>
            <p><strong>Status:</strong> <span class="badge backup-never-backed-up">Never Backed Up</span>
               (Service: N/A)
            </p>
            <p>Last Successful Backup: N/A</p>
            <p class="no-items">No backup file details.</p>

            <p class="section-title">Last Local Update:</p>
            <p>2024-06-06 10:00:00 UTC</p>
        </div>
    </div>
    </div>
        <div id="paginationControls" class="pagination-controls"></div>
    </div>

    <div id="epubModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="modal-close-btn" onclick="closeEpubModal()">&times;</span>
            <h3 id="modalEpubName"></h3>
            <div id="modalEpubCoverPlaceholder" class="epub-cover-placeholder">ðŸ“–</div>
            <p><strong>Path:</strong> <span id="modalEpubPath"></span></p>
            <p><a id="modalEpubPathLink" href="#" target="_blank" rel="noopener noreferrer">Open EPUB (local path)</a></p>
        </div>
    </div>

    <script>
        // Global variables
let currentPage = 1;
const itemsPerPage = 25; // Number of items per page
let allVisibleStoryCards = []; // To store all cards initially or after filtering/sorting

// DOM Element caching (populated in DOMContentLoaded)
let searchInput = null;
let filterStatusSelect = null;
let sortSelect = null;
let storyListContainer = null;
let paginationControls = null;

// Modal DOM Elements
let epubModal = null;
let modalEpubName = null;
let modalEpubPath = null;
let modalEpubPathLink = null;
let modalEpubCoverPlaceholder = null; // Added this based on HTML structure

function toggleSynopsis(element) {
    element.classList.toggle('expanded');
    const toggleLink = element.nextElementSibling;
    if (element.classList.contains('expanded')) {
        toggleLink.textContent = '(Read less)';
    } else {
        toggleLink.textContent = '(Read more)';
    }
}

function displayPage(pageNumber, currentItems) {
    currentPage = pageNumber;
    const startIndex = (pageNumber - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;

    // Hide all cards in the current set first
    currentItems.forEach(card => card.style.display = 'none');

    // Show only the cards for the current page
    const pageItems = currentItems.slice(startIndex, endIndex);
    pageItems.forEach(card => card.style.display = 'flex'); // Assuming 'flex' is the default display

    updatePaginationControlsUI(currentItems.length);
}

function updatePaginationControlsUI(totalItemsCount) {
    if (!paginationControls) return; // Ensure paginationControls is cached

    const totalPages = Math.ceil(totalItemsCount / itemsPerPage);

    const pageLinks = paginationControls.querySelectorAll('.page-link');
    pageLinks.forEach(link => {
        link.classList.remove('active');
        if (parseInt(link.dataset.page) === currentPage) {
            link.classList.add('active');
        }
    });

    const prevButton = paginationControls.querySelector('.page-button[data-action="prev"]');
    const nextButton = paginationControls.querySelector('.page-button[data-action="next"]');

    if (prevButton) {
        prevButton.classList.toggle('disabled', currentPage === 1);
    }
    if (nextButton) {
        nextButton.classList.toggle('disabled', currentPage === totalPages || totalPages === 0);
    }
}

function setupPaginationControls(totalItemsCount, itemsPerPage, containerId, displayFnForPageChange) {
    const container = document.getElementById(containerId); // paginationControls is already cached
    if (!container) return;
    container.innerHTML = ''; // Clear existing controls

    const totalPages = Math.ceil(totalItemsCount / itemsPerPage);
    if (totalPages <= 1) return; // No controls needed for single page

    let paginationHTML = '';

    // Previous Button
    paginationHTML += `<button class="page-button" data-action="prev">&laquo; Prev</button>`;

    // Page Number Links
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
             paginationHTML += `<a href="#" class="page-link" data-page="${i}">${i}</a>`;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
             paginationHTML += `<span class="page-ellipsis">...</span>`;
        }
    }

    // Next Button
    paginationHTML += `<button class="page-button" data-action="next">&raquo; Next</button>`;

    container.innerHTML = paginationHTML;

    // Add event listeners
    container.querySelectorAll('.page-button, .page-link').forEach(el => {
        el.addEventListener('click', function(event) {
            event.preventDefault();
            const pageAction = this.dataset.action;
            const pageNum = this.dataset.page;
            let newPageToDisplay;

            if (pageAction === 'prev') {
                newPageToDisplay = currentPage - 1;
            } else if (pageAction === 'next') {
                newPageToDisplay = currentPage + 1;
            } else if (pageNum) {
                newPageToDisplay = parseInt(pageNum);
            }

            if (newPageToDisplay) {
                 handlePageChange(newPageToDisplay, totalItemsCount, displayFnForPageChange);
            }
        });
    });
}

function handlePageChange(newPage, totalItems, displayFn) {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    if (newPage < 1 || newPage > totalPages) return;
    displayFn(newPage, allVisibleStoryCards); // displayFn is displayPage
}

function filterStories() {
    if (!searchInput || !filterStatusSelect || !storyListContainer) return; // Ensure elements are cached

    let filterTitle = searchInput.value.toUpperCase();
    let statusFilter = filterStatusSelect.value;

    // Reset to all cards from the DOM before filtering
    // This assumes all cards are initially within storyListContainer
    const originalCards = Array.from(storyListContainer.children).filter(child => child.classList.contains('story-card'));

    allVisibleStoryCards = originalCards.filter(card => {
        let title = (card.dataset.title || '').toUpperCase();
        let author = (card.dataset.author || '').toUpperCase();
        let status = card.dataset.status || '';

        let titleMatch = title.includes(filterTitle) || author.includes(filterTitle);
        let statusMatch = (statusFilter === "" || status === statusFilter);
        return titleMatch && statusMatch;
    });

    // No direct DOM manipulation for filtering here; pagination handles display
    setupPaginationControls(allVisibleStoryCards.length, itemsPerPage, 'paginationControls', displayPage);
    displayPage(1, allVisibleStoryCards);
}

function sortStories() {
    if (!sortSelect || !storyListContainer) return; // Ensure elements are cached

    let sortValue = sortSelect.value;

    // If allVisibleStoryCards is empty (e.g. after a filter that returns no results),
    // or if it hasn't been populated yet (e.g. sort is the first action before any filtering/initial load processing)
    // we should ensure it's populated.
    if (!allVisibleStoryCards || allVisibleStoryCards.length === 0) {
        const currentCardsInDOM = Array.from(storyListContainer.children).filter(child => child.classList.contains('story-card'));
         // Check if cards are currently displayed by a filter or if it's an empty filter result
        const activeFilter = searchInput.value || filterStatusSelect.value;
        if (!activeFilter && currentCardsInDOM.length > 0) {
            // If no filter is active, and cards are in DOM, use them (e.g. initial load, no filter applied yet)
            allVisibleStoryCards = currentCardsInDOM;
        } else if (!activeFilter && currentCardsInDOM.length === 0 && allVisibleStoryCards.length === 0) {
            // True initial load, no cards in allVisibleStoryCards, no cards in DOM (they are all display:none by default until first displayPage)
            // So, get all cards from the container.
            allVisibleStoryCards = Array.from(document.querySelectorAll('#storyListContainer .story-card'));
        }
        // If a filter is active and resulted in zero cards, allVisibleStoryCards is already correctly empty.
    }


    allVisibleStoryCards.sort(function(a, b) {
        let valA, valB;
        switch (sortValue) {
            case 'title':
                valA = a.dataset.title || '';
                valB = b.dataset.title || '';
                return valA.localeCompare(valB);
            case 'last_updated_desc':
                valA = a.dataset.lastUpdated || '';
                valB = b.dataset.lastUpdated || '';
                return valB.localeCompare(valA); // Descending
            case 'last_updated_asc':
                valA = a.dataset.lastUpdated || '';
                valB = b.dataset.lastUpdated || '';
                return valA.localeCompare(valB); // Ascending
            case 'progress_desc':
                valA = parseInt(a.dataset.progress || 0);
                valB = parseInt(b.dataset.progress || 0);
                return valB - valA; // Descending
            default:
                return 0;
        }
    });

    // displayPage will handle showing the sorted cards from allVisibleStoryCards.
    // No direct DOM manipulation for sorting here.
    setupPaginationControls(allVisibleStoryCards.length, itemsPerPage, 'paginationControls', displayPage);
    displayPage(1, allVisibleStoryCards);
}

function toggleExtraEpubs(story_id_sanitized, buttonElement, totalEpubs, threshold) {
    const moreEpubsDiv = document.getElementById(`more-epubs-${story_id_sanitized}`);
    if (moreEpubsDiv) {
        const isHidden = moreEpubsDiv.style.display === 'none';
        moreEpubsDiv.style.display = isHidden ? 'block' : 'none';
        if (isHidden) {
            buttonElement.textContent = 'Show fewer EPUBs';
        } else {
            buttonElement.textContent = `Show all ${totalEpubs} EPUBs`;
        }
    }
}

// Modal Functions
function openEpubModal(element) {
    if (!epubModal || !modalEpubName || !modalEpubPath || !modalEpubPathLink || !modalEpubCoverPlaceholder) {
        console.error("Modal elements not cached correctly.");
        return;
    }

    const epubName = element.dataset.epubName;
    const epubPath = element.dataset.epubPath;

    modalEpubName.textContent = epubName;
    // modalEpubCoverPlaceholder.textContent = 'ðŸ“–'; // Already in HTML, but could update if dynamic

    // Display the path textually for user info
    modalEpubPath.textContent = epubPath;

    // Create a file URI for the link
    // Note: Direct linking to local files has security restrictions in many browsers.
    // This creates the link, but it might not work as expected without browser configuration
    // or if the report is not viewed locally.
    if (epubPath) {
        // Assuming epubPath is an absolute path. If it's relative, more logic is needed.
        // For security, browsers are very restrictive about file:/// links from http/https pages.
        // If this report is opened as a local file itself, file:/// links are more likely to work.
        modalEpubPathLink.href = `file:///${epubPath}`;
    } else {
        modalEpubPathLink.href = '#'; // Fallback if path is missing
    }

    epubModal.style.display = 'block';
}

function closeEpubModal() {
    if (epubModal) {
        epubModal.style.display = 'none';
    }
}


document.addEventListener('DOMContentLoaded', function() {
    // Cache DOM elements
    searchInput = document.getElementById('searchInput');
    filterStatusSelect = document.getElementById('filterStatusSelect');
    sortSelect = document.getElementById('sortSelect');
    storyListContainer = document.getElementById('storyListContainer');
    paginationControls = document.getElementById('paginationControls');

    // Cache Modal DOM elements
    epubModal = document.getElementById('epubModal');
    modalEpubName = document.getElementById('modalEpubName');
    modalEpubPath = document.getElementById('modalEpubPath');
    modalEpubPathLink = document.getElementById('modalEpubPathLink');
    modalEpubCoverPlaceholder = document.getElementById('modalEpubCoverPlaceholder');

    // Event listener for closing modal on outside click
    if (epubModal) {
        epubModal.addEventListener('click', function(event) {
            if (event.target === epubModal) { // Check if the click is on the modal overlay itself
                closeEpubModal();
            }
        });
    }

    if (storyListContainer) {
        // Get all cards present in the container at load time
        allVisibleStoryCards = Array.from(storyListContainer.children).filter(child => child.classList.contains('story-card'));

        if (allVisibleStoryCards.length > 0) {
            setupPaginationControls(allVisibleStoryCards.length, itemsPerPage, 'paginationControls', displayPage);
            displayPage(1, allVisibleStoryCards);
        } else {
            // Handle case where storyListContainer is empty or has no story-cards
            // console.log("No story cards found on initial load.");
            // Still setup pagination controls (it will show nothing if totalItems is 0)
             setupPaginationControls(0, itemsPerPage, 'paginationControls', displayPage);
             displayPage(1, []); // Display an empty page
        }
    } else {
        // console.error("Story list container not found.");
    }

    // Add event listeners for filter and sort controls
    if (searchInput) {
        searchInput.addEventListener('keyup', filterStories);
    }
    if (filterStatusSelect) {
        filterStatusSelect.addEventListener('change', filterStories);
    }
    if (sortSelect) {
        sortSelect.addEventListener('change', sortStories);
    }
});

    </script>
</body>
</html>
